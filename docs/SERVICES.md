# Services Guide

This document describes the backend services in Bibanna. Services encapsulate business logic and are located in `server/services/`.

## Service Organization

```
server/services/
├── citation/      # CSL processing and citation formatting
├── companion/     # Research Companion RAG system
├── export/        # PDF, Excel, BibTeX generation
├── graph/         # Mind map data building
├── sharing/       # Project sharing logic
├── stripe/        # Payment processing
├── url/           # URL metadata extraction
└── veritas/       # Credibility scoring
```

---

## Citation Service

Handles citation formatting using Citation Style Language (CSL).

### Files

- `server/services/citation/csl-processor.ts` - Core citeproc-js wrapper
- `server/services/citation/default-styles.ts` - Built-in style definitions
- `server/services/citation/index.ts` - Public API

### Key Functions

```typescript
// Format entries as bibliography
async function formatBibliography(
  entries: Entry[],
  styleId: string,
  options?: { numbered?: boolean }
): Promise<string>

// Format single entry for in-text citation
async function formatCitation(
  entry: Entry,
  styleId: string
): Promise<string>

// Get style metadata
async function getStyleInfo(styleId: string): Promise<StyleInfo>

// Validate custom CSL XML
async function validateCslXml(xml: string): Promise<ValidationResult>

// Convert entry to CSL-JSON format
function entryToCslJson(entry: Entry): CslJson
```

### CSL Processing Flow

```
Entry Data → entryToCslJson() → CSL-JSON
                                    ↓
Style ID → fetchCslXml() → CSL XML
                                    ↓
        citeproc-js Engine ← CSL-JSON + CSL XML
                                    ↓
                            Formatted Output
```

### Default Styles

The system includes these commonly used styles:
- APA 7th Edition
- MLA 9th Edition
- Chicago (Author-Date)
- Chicago (Notes-Bibliography)
- Harvard
- IEEE
- Vancouver
- Turabian
- AMA

Custom styles can be created via the Style Builder or by uploading CSL XML.

---

## Companion Service (RAG)

Powers the Research Companion AI assistant.

### Files

- `server/services/companion/document-ingestion.ts` - Document chunking and embedding
- `server/services/companion/rag-query.ts` - Vector search and LLM interaction
- `server/services/companion/persona-generator.ts` - AI persona generation
- `server/services/companion/index.ts` - Public API

### Document Ingestion

```typescript
// Process entry content for RAG
async function ingestEntry(
  projectId: string,
  entry: Entry
): Promise<void>

// Process uploaded file
async function ingestUpload(
  projectId: string,
  upload: ProjectUpload
): Promise<void>

// Chunk text content
function chunkText(
  text: string,
  options?: ChunkOptions
): TextChunk[]

// Generate embeddings for chunks
async function embedChunks(
  chunks: TextChunk[]
): Promise<EmbeddedChunk[]>
```

**Chunking Strategy:**
- Default chunk size: 1000 tokens
- Overlap: 200 tokens
- Splits at sentence boundaries when possible
- Preserves metadata (source entry, page number)

### RAG Query Flow

```
User Query
     ↓
generateEmbedding(query)
     ↓
vectorSearch(embedding, projectId)
     ↓
Top-K Relevant Chunks
     ↓
buildContext(chunks, persona, conversationHistory)
     ↓
LLM Generation (GPT-4o)
     ↓
extractCitations(response, chunks)
     ↓
Response with Citations + Follow-ups
```

```typescript
// Main chat function
async function chat(
  projectId: string,
  userId: string,
  message: string,
  options: ChatOptions
): Promise<ChatResponse>

interface ChatOptions {
  conversationId?: string
  mode: 'general' | 'synthesize' | 'fact-check' | 'brainstorm' | 'gaps'
  maxChunks?: number
}

interface ChatResponse {
  message: CompanionMessage
  conversationId: string
}
```

### Persona Generation

```typescript
// Generate or update research persona
async function generatePersona(
  projectId: string
): Promise<ResearchPersona>
```

Personas are generated by analyzing:
- Entry titles and abstracts
- Annotation content
- Tag distribution
- Research themes

The persona influences:
- Response tone and style
- Domain-specific terminology
- Suggested follow-up questions

---

## Export Service

Generates downloadable files in various formats.

### Files

- `server/services/export/excel.ts` - Excel generation with ExcelJS
- `server/services/export/pdf.ts` - PDF generation with Puppeteer
- `server/services/export/bibtex.ts` - BibTeX conversion
- `server/services/export/excel-presets.ts` - Preset definitions
- `server/services/export/index.ts` - Public API

### Excel Export

```typescript
async function generateExcel(
  entries: Entry[],
  options: ExcelOptions
): Promise<Buffer>

interface ExcelOptions {
  preset: ExcelPreset
  includeAnnotations: boolean
  formatting: {
    headerColor: string
    zebra: boolean
    freezeHeader: boolean
  }
}
```

**Features:**
- Multiple sheets (entries, annotations, summary)
- Customizable columns and order
- Auto-width columns
- Hyperlinks for URLs
- Formatted dates

### PDF Export

```typescript
async function generatePdf(
  entries: Entry[],
  options: PdfOptions
): Promise<Buffer>

interface PdfOptions {
  styleId: string
  title?: string
  includeAnnotations: boolean
  pageSize: 'letter' | 'a4'
  margins: { top: number; bottom: number; left: number; right: number }
}
```

Uses Puppeteer to render HTML template and convert to PDF.

### BibTeX Export

```typescript
async function generateBibtex(
  entries: Entry[]
): Promise<string>
```

Converts entries to standard BibTeX format with proper escaping and field mapping.

---

## Graph Service

Builds graph data for mind map visualization.

### Files

- `server/services/graph/build-graph.ts` - Graph construction

### Graph Building

```typescript
async function buildProjectGraph(
  projectId: string,
  options: GraphOptions
): Promise<GraphData>

interface GraphOptions {
  includeAuthors: boolean
  includeTags: boolean
  includeSimilarity: boolean
  similarityThreshold: number
}

interface GraphData {
  nodes: GraphNode[]
  edges: GraphEdge[]
}

interface GraphNode {
  id: string
  type: 'entry' | 'author' | 'tag' | 'topic'
  label: string
  metadata: Record<string, any>
}

interface GraphEdge {
  source: string
  target: string
  type: 'authored_by' | 'has_tag' | 'similar_to' | 'cites'
  weight?: number
}
```

### Node Types

| Type | Source | Connections |
|------|--------|-------------|
| entry | entries table | authors, tags, similar entries |
| author | entry.authors JSONB | entries they authored |
| tag | tags table | entries with that tag |
| topic | derived from embeddings | clustered entries |

### Edge Types

| Type | Description | Weight |
|------|-------------|--------|
| authored_by | Entry → Author | N/A |
| has_tag | Entry → Tag | N/A |
| similar_to | Entry ↔ Entry | Cosine similarity |
| cites | Entry → Entry | N/A (future) |

---

## Sharing Service

Manages project sharing and access control.

### Files

- `server/services/sharing/index.ts` - Sharing logic

### Functions

```typescript
// Create user share
async function shareWithUser(
  projectId: string,
  ownerId: string,
  targetEmail: string,
  permission: SharePermission
): Promise<ProjectShare>

// Create public link
async function createPublicLink(
  projectId: string,
  ownerId: string,
  options: PublicLinkOptions
): Promise<ProjectShare>

interface PublicLinkOptions {
  permission: SharePermission
  expiresInDays?: number
}

// Check access
async function checkAccess(
  projectId: string,
  userId: string | null,
  token: string | null
): Promise<AccessResult>

interface AccessResult {
  hasAccess: boolean
  permission: SharePermission | null
  isOwner: boolean
}

// Revoke share
async function revokeShare(
  shareId: string,
  ownerId: string
): Promise<void>
```

### Access Resolution

```
Request → checkAccess()
              ↓
        Is User Owner? → Yes → Full Access
              ↓ No
        Has User Share? → Yes → Share Permission
              ↓ No
        Valid Public Token? → Yes → Token Permission
              ↓ No
        Access Denied
```

---

## Stripe Service

Handles payment processing and subscription management.

### Files

- `server/services/stripe/index.ts` - Stripe integration

### Functions

```typescript
// Create checkout session
async function createCheckoutSession(
  userId: string,
  tier: 'light' | 'pro',
  interval: 'monthly' | 'yearly'
): Promise<string> // Returns checkout URL

// Create customer portal session
async function createPortalSession(
  userId: string
): Promise<string> // Returns portal URL

// Handle webhook events
async function handleWebhook(
  body: string,
  signature: string
): Promise<void>

// Get subscription details
async function getSubscription(
  userId: string
): Promise<SubscriptionDetails | null>

// Cancel subscription
async function cancelSubscription(
  subscriptionId: string,
  immediately: boolean
): Promise<void>
```

### Webhook Events

| Event | Action |
|-------|--------|
| checkout.session.completed | Create subscription, update tier |
| customer.subscription.created | Store subscription details |
| customer.subscription.updated | Update tier, status, period |
| customer.subscription.deleted | Downgrade to free tier |
| invoice.payment_succeeded | Update payment status |
| invoice.payment_failed | Mark subscription past_due |

### Price Configuration

```typescript
const PRICES = {
  light: {
    monthly: 'price_xxx', // $9/month
    yearly: 'price_xxx'   // $90/year
  },
  pro: {
    monthly: 'price_xxx', // $19/month
    yearly: 'price_xxx'   // $190/year
  }
}
```

---

## URL Metadata Service

Extracts bibliographic metadata from URLs.

### Files

- `server/services/url/metadata-extractor.ts` - Multi-strategy extraction
- `server/services/url/ai-fallback.ts` - GPT-4o-mini fallback

### Extraction Flow

```
URL Input
     ↓
Fetch HTML Content
     ↓
Try Extractors (in order):
  1. Schema.org JSON-LD
  2. Open Graph meta tags
  3. Twitter Card meta tags
  4. HTML meta tags
  5. Site-specific parsers
  6. AI fallback (optional)
     ↓
Merge & Deduplicate Results
     ↓
Map to Entry Fields
     ↓
Return Metadata with Confidence
```

```typescript
async function extractMetadata(
  url: string,
  options?: ExtractOptions
): Promise<ExtractedMetadata>

interface ExtractOptions {
  useAI: boolean
  timeout: number
}

interface ExtractedMetadata {
  title?: string
  authors?: Author[]
  publisher?: string
  publicationDate?: string
  entryType?: EntryType
  abstract?: string
  doi?: string
  confidence: number
  source: string[]
}
```

### Site-Specific Parsers

Custom parsers for common academic sites:
- Google Scholar
- PubMed/NCBI
- arXiv
- JSTOR
- ResearchGate
- Academia.edu

---

## Veritas Service

Calculates credibility scores for sources.

### Files

- `server/services/veritas/publishers.ts` - Publisher tier definitions
- `server/services/veritas/external-apis.ts` - External API integrations
- `server/services/veritas/index.ts` - Score calculation

### Score Calculation

```typescript
async function calculateVeritasScore(
  entry: Entry
): Promise<VeritasScore>

interface VeritasScore {
  overall: number        // 0-100
  confidence: number     // 0-100
  label: string          // 'High', 'Moderate', 'Low', 'Unknown'
  factors: VeritasFactor[]
  sources: string[]      // APIs used
  calculatedAt: Date
}

interface VeritasFactor {
  name: string
  score: number
  weight: number
  evidence: string
  sources: string[]
}
```

### Scoring Factors

| Factor | Weight | Source |
|--------|--------|--------|
| Publisher Reputation | 20% | Internal tier list |
| Peer Review Status | 20% | OpenAlex, DOAJ |
| Author Credentials | 15% | Semantic Scholar, ORCID |
| Citation Impact | 15% | Semantic Scholar, OpenAlex |
| Recency | 10% | Publication date |
| Journal Impact | 10% | Scimago, OpenAlex |
| Retraction Check | 10% | OpenAlex, CrossRef |

### External APIs

```typescript
// Semantic Scholar
async function fetchSemanticScholarData(
  doi: string | null,
  title: string
): Promise<SemanticScholarResult>

// OpenAlex
async function fetchOpenAlexData(
  doi: string | null,
  title: string
): Promise<OpenAlexResult>

// CrossRef
async function fetchCrossRefData(
  doi: string
): Promise<CrossRefResult>
```

### Publisher Tiers

```typescript
const PUBLISHER_TIERS = {
  tier1: {
    score: 95,
    publishers: [
      'Nature Publishing Group',
      'Science/AAAS',
      'Cell Press',
      // ... major university presses
    ]
  },
  tier2: {
    score: 85,
    publishers: [
      'Elsevier',
      'Springer',
      'Wiley',
      // ... established publishers
    ]
  },
  tier3: {
    score: 70,
    publishers: [
      // Regional publishers, smaller presses
    ]
  }
}
```

---

## Service Patterns

### Error Handling

All services use `pkg/errors` for error wrapping:

```typescript
import { errors } from '@pkg/errors'

async function someService() {
  try {
    const result = await externalApi.call()
    return result
  } catch (err) {
    throw errors.wrap(err, 'failed to call external API')
  }
}
```

### Caching

Expensive operations use in-memory or database caching:

```typescript
const cache = new Map<string, CachedResult>()

async function getCachedOrFetch(key: string) {
  const cached = cache.get(key)
  if (cached && Date.now() - cached.timestamp < TTL) {
    return cached.data
  }
  
  const data = await fetchData(key)
  cache.set(key, { data, timestamp: Date.now() })
  return data
}
```

### Rate Limiting

External API calls respect rate limits:

```typescript
const rateLimiter = new RateLimiter({
  tokensPerInterval: 10,
  interval: 'second'
})

async function callExternalApi() {
  await rateLimiter.removeTokens(1)
  return api.call()
}
```

### Logging

Services use structured logging:

```typescript
import { logger } from '~/server/utils/logger'

logger.info('Processing entry', {
  entryId: entry.id,
  operation: 'veritas-calculation'
})
```
